name: LeetCode Auto Sync

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync_solutions:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: LeetCode Submissions Sync
        uses: joshcai/leetcode-sync@v1.5
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          leetcode-session: ${{ secrets.LEETCODE_SESSION }}
          leetcode-csrf-token: ${{ secrets.LEETCODE_CSRF_TOKEN }}
          destination-folder: temp_solutions

      - name: Organize into separate folders
        run: |
          # Check if temp_solutions/problems exists
          if [ -d "temp_solutions/problems" ]; then
            cd temp_solutions/problems
          elif [ -d "temp_solutions" ]; then
            cd temp_solutions
          else
            echo "No solutions found"
            exit 0
          fi
          
          # Process each solution file
          for file in *; do
            if [ -f "$file" ]; then
              # Extract problem number and name
              filename="${file%.*}"
              extension="${file##*.}"
              
              # Create folder in root with problem name
              mkdir -p "../../$filename"
              
              # Move file into its folder
              cp "$file" "../../$filename/solution.$extension"
              
              # Create a README for each problem
              echo "# $filename" > "../../$filename/README.md"
            fi
          done
          
          # Go back to root and remove temp folder
          cd ../..
          rm -rf temp_solutions

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff --quiet && git diff --staged --quiet || (git commit -m "Sync LeetCode solutions" && git push)
